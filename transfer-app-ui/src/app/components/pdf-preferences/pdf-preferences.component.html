<div class="pdf-preferences-container">
  <div class="header">
    <h2>PDF Preference Extraction</h2>
    <p>Upload a PDF to automatically extract doctor preferences and set them as your vacancy preferences.</p>
  </div>

  <!-- File Upload Section -->
  <div class="upload-section">
    <div class="file-upload-area" [class.has-file]="selectedFile">
      <input 
        type="file" 
        id="pdfFile" 
        accept=".pdf" 
        (change)="onFileSelected($event)"
        class="file-input"
      >
      <label for="pdfFile" class="file-label">
        <div class="upload-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7,10 12,15 17,10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        </div>
        <div class="upload-text">
          <span *ngIf="!selectedFile; else fileName">
            Click to upload PDF or drag and drop
          </span>
          <ng-template #fileName>
            <strong>{{ selectedFile?.name }}</strong>
          </ng-template>
        </div>
        <div class="upload-hint">
          PDF files only
        </div>
      </label>
    </div>

    <button 
      *ngIf="selectedFile" 
      (click)="extractPreferences()" 
      [disabled]="isLoading"
      class="extract-btn primary-btn"
    >
      <span *ngIf="!isLoading">Extract Preferences</span>
      <span *ngIf="isLoading">Processing...</span>
    </button>
  </div>

  <!-- Message Display -->
  <div *ngIf="message" class="message" [class]="'message-' + messageType">
    <span>{{ message }}</span>
    <button (click)="clearMessage()" class="close-btn">&times;</button>
  </div>

  <!-- Extracted Preferences Section -->
  <div *ngIf="mappedPreferences.length > 0" class="preferences-section">
    <h3>Extracted Preferences ({{ mappedPreferences.length }} total)</h3>
    
    <!-- Statistics Dashboard -->
    <div class="statistics-dashboard">
      <div class="stat-item">
        <div class="stat-number">{{ statistics.total }}</div>
        <div class="stat-label">Total Recognized</div>
      </div>
      <div class="stat-item">
        <div class="stat-number matched">{{ statistics.matched }}</div>
        <div class="stat-label">Mapped</div>
      </div>
      <div class="stat-item">
        <div class="stat-number unmatched">{{ statistics.unmatched }}</div>
        <div class="stat-label">Unmapped</div>
      </div>
             <div class="stat-item" 
            [class.has-duplicates]="statistics.duplicates > 0"
            [class.clickable]="statistics.duplicates > 0"
            (click)="showDuplicatesPopup()"
            title="Click to view duplicate details">
         <div class="stat-number duplicates">{{ statistics.duplicates }}</div>
         <div class="stat-label">Duplicates</div>
       </div>
         </div>
     
     <!-- Duplicates Popup -->
     <div *ngIf="showDuplicatePopup" class="duplicate-popup-overlay" (click)="closeDuplicatePopup()">
       <div class="duplicate-popup" (click)="$event.stopPropagation()">
         <div class="popup-header">
           <h3>Duplicate Preferences Found</h3>
           <button class="close-popup-btn" (click)="closeDuplicatePopup()">&times;</button>
         </div>
         <div class="popup-content">
           <p class="popup-description">
             The following vacancies have been selected multiple times. Please remove duplicates before saving.
           </p>
           <div class="duplicate-list">
             <div *ngFor="let duplicate of duplicateDetails" class="duplicate-item">
               <div class="duplicate-info">
                 <span class="duplicate-name">{{ duplicate.vacancyName }}</span>
                 <span class="duplicate-count">Selected {{ duplicate.count }} time(s)</span>
               </div>
             </div>
           </div>
         </div>
         <div class="popup-footer">
           <button class="close-btn-secondary" (click)="closeDuplicatePopup()">Close</button>
         </div>
       </div>
     </div>
     
     <p>Review and map the extracted preferences to available vacancies:</p>

    <!-- Virtual Scrolling Container -->
    <cdk-virtual-scroll-viewport 
      [itemSize]="itemSize" 
      [maxBufferPx]="maxBufferPx" 
      [minBufferPx]="minBufferPx"
      class="virtual-scroll-viewport"
    >
             <div 
         *cdkVirtualFor="let item of mappedPreferences; let i = index" 
         class="preference-item"
         [class.mapped]="item.vacancy"
       >
                   <div class="extracted-info">
            <div class="preference-header">
              <h4>Preference {{ i + 1 }}</h4>
              <div class="preference-status" *ngIf="item.extracted.isMatched">
                <span class="status-badge">✓ Auto-Matched</span>
              </div>
            </div>
            
            <div class="preference-details-table">
              <div class="detail-row">
                <div class="detail-cell">
                  <span class="detail-label">Vacancy:</span>
                  <span class="detail-value">{{ item.extracted.vacancyName }}</span>
                </div>
                <div class="detail-cell">
                  <span class="detail-label">Institute:</span>
                  <span class="detail-value">{{ item.extracted.institute }}</span>
                </div>
              </div>
              <div class="detail-row">
                <div class="detail-cell">
                  <span class="detail-label">Designation:</span>
                  <span class="detail-value">{{ item.extracted.postDesignation }}</span>
                </div>
                <div class="detail-cell">
                  <span class="detail-label">Raw Line:</span>
                  <span class="detail-value raw-line">{{ item.extracted.rawLine }}</span>
                </div>
              </div>
            </div>
            
            <div class="vacancy-mapping">
              <label for="vacancy-{{ i }}">Map to Vacancy:</label>
              
              <!-- Searchable Dropdown -->
              <div class="searchable-dropdown">
                <div class="dropdown-header" (click)="toggleDropdown(i)">
                  <span class="selected-text">
                    {{ item.vacancy ? (item.vacancy.designation + ' - ' + item.vacancy.institution + ' (' + item.vacancy.district + ')') : '-- Select Vacancy --' }}
                  </span>
                  <span class="dropdown-arrow">▼</span>
                </div>
                
                <div class="dropdown-content" *ngIf="item.showDropdown">
                  <div class="search-box">
                    <input 
                      type="text" 
                      [placeholder]="'Search vacancies...'"
                      [value]="searchTerms[i] || ''"
                      (input)="onSearchChange(i, $event)"
                      (focus)="onSearchFocus(i)"
                      (blur)="onSearchBlur(i)"
                      class="search-input"
                      (click)="$event.stopPropagation()"
                    >
                  </div>
                  
                  <div class="vacancy-options">
                    <div 
                      *ngFor="let vacancy of getFilteredVacancies(i)" 
                      class="vacancy-option"
                      [class.selected]="item.vacancy?.id === vacancy.id"
                      (click)="updatePreferenceMapping(i, vacancy); toggleDropdown(i)"
                    >
                      <div class="vacancy-name">{{ vacancy.designation }} - {{ vacancy.institution }}</div>
                      <div class="vacancy-district">({{ vacancy.district }})</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Clear Selection Button -->
              <button 
                *ngIf="item.vacancy" 
                type="button"
                (click)="clearVacancySelection(i)"
                class="clear-selection-btn"
                title="Clear vacancy selection"
              >
                ✕ Clear
              </button>
            </div>
         </div>
       </div>
    </cdk-virtual-scroll-viewport>

    <div class="actions">
      <button 
        (click)="confirmPreferences()" 
        [disabled]="isLoading"
        class="confirm-btn primary-btn"
      >
        <span *ngIf="!isLoading">Confirm Preferences</span>
        <span *ngIf="isLoading">Saving...</span>
      </button>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p>Processing...</p>
  </div>
</div>

<style>
  .pdf-preferences-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }

  .header h2 {
    margin: 0 0 10px 0;
    font-size: 2.5em;
    font-weight: 300;
  }

  .header p {
    margin: 0;
    font-size: 1.1em;
    opacity: 0.9;
  }

  .upload-section {
    margin-bottom: 30px;
    text-align: center;
  }

  .file-upload-area {
    border: 3px dashed #ddd;
    border-radius: 10px;
    padding: 40px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
    background: #fafafa;
  }

  .file-upload-area:hover {
    border-color: #667eea;
    background: #f0f4ff;
  }

  .file-upload-area.has-file {
    border-color: #28a745;
    background: #f0fff4;
  }

  .file-input {
    display: none;
  }

  .file-label {
    cursor: pointer;
    display: block;
  }

  .upload-icon {
    margin-bottom: 15px;
    color: #667eea;
  }

  .upload-text {
    font-size: 1.2em;
    margin-bottom: 10px;
    color: #333;
  }

  .upload-hint {
    color: #666;
    font-size: 0.9em;
  }

  .extract-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    font-size: 1.1em;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }

  .extract-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }

  .extract-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .message {
    padding: 15px 20px;
    border-radius: 8px;
    margin: 20px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
  }

  .message-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .message-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .message-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
  }

  .close-btn {
    background: none;
    border: none;
    font-size: 1.5em;
    cursor: pointer;
    color: inherit;
    opacity: 0.7;
  }

  .close-btn:hover {
    opacity: 1;
  }

  .preferences-section {
    margin-top: 30px;
  }

  .preferences-section h3 {
    color: #333;
    margin-bottom: 15px;
    font-size: 1.8em;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
  }

  .statistics-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin: 20px 0;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
  }

  .stat-item {
    text-align: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }

  .stat-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  }

  .stat-number {
    font-size: 2.5em;
    font-weight: 700;
    margin-bottom: 8px;
    color: #333;
  }

  .stat-number.matched {
    color: #28a745;
  }

  .stat-number.unmatched {
    color: #ffc107;
  }

  .stat-number.duplicates {
    color: #dc3545;
  }

  .stat-label {
    font-size: 0.9em;
    color: #666;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-item.has-duplicates {
    border: 2px solid #dc3545;
    background: #fff5f5;
  }
  
  .stat-item.clickable {
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .stat-item.clickable:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
  }

  .virtual-scroll-viewport {
    height: 800px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: white;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  .preference-item {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    background: white;
    transition: all 0.2s ease;
  }

  .preference-item:hover {
    background: #f8f9fa;
  }

  .preference-item.mapped {
    background: #f0fff4;
    border-left: 4px solid #28a745;
  }

  .extracted-info {
    width: 100%;
  }

  .preference-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .extracted-info h4 {
    margin: 0;
    color: #333;
    font-size: 1em;
    font-weight: 600;
  }

  .preference-status {
    display: flex;
    align-items: center;
  }

  .status-badge {
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 600;
  }

  .preference-details-table {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 8px;
  }

  .detail-row {
    display: contents;
  }

  .detail-cell {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .detail-label {
    color: #555;
    font-size: 0.75em;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .detail-value {
    color: #333;
    font-size: 0.85em;
    line-height: 1.2;
    word-break: break-word;
  }

  .detail-value.raw-line {
    font-family: monospace;
    font-size: 0.75em;
    color: #666;
    background: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    border: 1px solid #e9ecef;
  }

  .text-success {
    color: #28a745;
    font-weight: 600;
  }

  .vacancy-mapping {
    margin-top: 15px;
    width: 100%;
  }

  .vacancy-mapping label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  .vacancy-select {
    width: 100%;
    padding: 8px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 0.9em;
    background: white;
    transition: border-color 0.2s ease;
  }

  .vacancy-select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  /* Searchable Dropdown Styles */
  .searchable-dropdown {
    position: relative;
    width: 100%;
  }
  
  .dropdown-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    transition: border-color 0.2s ease;
    min-height: 42px;
  }
  
  .dropdown-header:hover {
    border-color: #667eea;
  }
  
  .selected-text {
    flex: 1;
    color: #333;
    font-size: 0.9em;
  }
  
  .dropdown-arrow {
    color: #666;
    font-size: 0.8em;
    transition: transform 0.2s ease;
  }
  
  .dropdown-content {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 2px solid #667eea;
    border-top: none;
    border-radius: 0 0 6px 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    max-height: 300px;
    overflow: hidden;
  }
  
  .search-box {
    padding: 10px;
    border-bottom: 1px solid #eee;
    background: #f8f9fa;
  }
  
  .search-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9em;
    outline: none;
  }
  
  .search-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
  }
  
  .vacancy-options {
    max-height: 250px;
    overflow-y: auto;
  }
  
  .vacancy-option {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s ease;
  }
  
  .vacancy-option:hover {
    background: #f8f9fa;
  }
  
  .vacancy-option.selected {
    background: #e3f2fd;
    border-left: 3px solid #667eea;
  }
  
  .vacancy-name {
    font-weight: 600;
    color: #333;
    font-size: 0.9em;
    margin-bottom: 2px;
  }
  
  .vacancy-district {
    color: #666;
    font-size: 0.8em;
  }
  
  .clear-selection-btn {
    margin-top: 8px;
    padding: 6px 12px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.8em;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  
  .clear-selection-btn:hover {
    background: #c82333;
  }

  .actions {
    margin-top: 30px;
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
  }

  .confirm-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 15px 40px;
    font-size: 1.2em;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }

  .confirm-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }

  .confirm-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    color: white;
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Responsive design */
  @media (max-width: 768px) {
    .pdf-preferences-container {
      padding: 15px;
    }

    .header h2 {
      font-size: 2em;
    }

    .preference-item {
      flex-direction: column;
      gap: 10px;
    }

    .preference-details-table {
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .vacancy-mapping {
      min-width: auto;
      width: 100%;
    }

         .virtual-scroll-viewport {
       height: 600px;
     }
   }
   
   /* Duplicate Popup Styles */
   .duplicate-popup-overlay {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0, 0, 0, 0.7);
     display: flex;
     justify-content: center;
     align-items: center;
     z-index: 1000;
   }
   
   .duplicate-popup {
     background: white;
     border-radius: 12px;
     box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
     max-width: 600px;
     width: 90%;
     max-height: 80vh;
     overflow: hidden;
     animation: popupSlideIn 0.3s ease-out;
   }
   
   @keyframes popupSlideIn {
     from {
       opacity: 0;
       transform: translateY(-20px) scale(0.95);
     }
     to {
       opacity: 1;
       transform: translateY(0) scale(1);
     }
   }
   
   .popup-header {
     background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
     color: white;
     padding: 20px;
     display: flex;
     justify-content: space-between;
     align-items: center;
   }
   
   .popup-header h3 {
     margin: 0;
     font-size: 1.4em;
     font-weight: 600;
   }
   
   .close-popup-btn {
     background: none;
     border: none;
     color: white;
     font-size: 1.8em;
     cursor: pointer;
     padding: 0;
     width: 30px;
     height: 30px;
     display: flex;
     align-items: center;
     justify-content: center;
     border-radius: 50%;
     transition: background-color 0.2s ease;
   }
   
   .close-popup-btn:hover {
     background: rgba(255, 255, 255, 0.2);
   }
   
   .popup-content {
     padding: 20px;
     max-height: 50vh;
     overflow-y: auto;
   }
   
   .popup-description {
     margin: 0 0 20px 0;
     color: #666;
     font-size: 1em;
     line-height: 1.5;
   }
   
   .duplicate-list {
     display: flex;
     flex-direction: column;
     gap: 15px;
   }
   
   .duplicate-item {
     background: #f8f9fa;
     border: 1px solid #e9ecef;
     border-radius: 8px;
     padding: 15px;
     transition: all 0.2s ease;
   }
   
   .duplicate-item:hover {
     background: #fff5f5;
     border-color: #dc3545;
   }
   
   .duplicate-info {
     display: flex;
     justify-content: space-between;
     align-items: center;
     gap: 15px;
   }
   
   .duplicate-name {
     font-weight: 600;
     color: #333;
     flex: 1;
   }
   
   .duplicate-count {
     background: #dc3545;
     color: white;
     padding: 6px 12px;
     border-radius: 20px;
     font-size: 0.85em;
     font-weight: 600;
     white-space: nowrap;
   }
   
   .popup-footer {
     padding: 20px;
     background: #f8f9fa;
     border-top: 1px solid #e9ecef;
     text-align: center;
   }
   
   .close-btn-secondary {
     background: #6c757d;
     color: white;
     border: none;
     padding: 10px 25px;
     border-radius: 6px;
     font-size: 1em;
     cursor: pointer;
     transition: background-color 0.2s ease;
   }
   
   .close-btn-secondary:hover {
     background: #5a6268;
   }
   
   /* Responsive popup */
   @media (max-width: 768px) {
     .duplicate-popup {
       width: 95%;
       max-height: 90vh;
     }
     
     .duplicate-info {
       flex-direction: column;
       align-items: flex-start;
       gap: 10px;
     }
     
     .duplicate-count {
       align-self: flex-end;
     }
   }
 </style>

